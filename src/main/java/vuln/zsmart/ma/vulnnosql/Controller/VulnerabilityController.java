package vuln.zsmart.ma.vulnnosql.Controller;

import org.bson.types.ObjectId;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import vuln.zsmart.ma.vulnnosql.Beans.User;
import vuln.zsmart.ma.vulnnosql.Beans.UserPrincipal;
import vuln.zsmart.ma.vulnnosql.Beans.Vulnerbilite;
import vuln.zsmart.ma.vulnnosql.Services.MyUserDetailServices;
import vuln.zsmart.ma.vulnnosql.Services.RoleService;
import vuln.zsmart.ma.vulnnosql.Services.VulnerabilityService;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Controller
public class VulnerabilityController {

    @Autowired
    VulnerabilityService vulnerabilityService;
    @Autowired
    MyUserDetailServices myUserDetailServices;
    @Autowired
    RoleService roleService;

    @PostMapping(value = "/tables.html/AddnewVuln")
    public String addVuln(@AuthenticationPrincipal UserPrincipal userPrincipal, Vulnerbilite v)
    {
        ObjectId id = userPrincipal.getId();
        Optional<User> userOP = myUserDetailServices.getUserById(id);
        User user = userOP.get();
        v.setAuthor(user);
        if(user.getVulnerbilites()==null)
        {
            List<Vulnerbilite> vulns = new ArrayList<>();
            vulns.add(v);
            user.setVulnerbilites(vulns);
        }else
        {
            user.getVulnerbilites().add(v);
        }
        vulnerabilityService.save(v);
        myUserDetailServices.save(user);

        return "redirect:/tables.html";
    }



    @GetMapping("/tables.html/view/user/{username}")
    public String viewtUserVuln(@PathVariable String username, Model model){
        User user = myUserDetailServices.findUserByUsername(username);
        model.addAttribute("authorResume", user);
        model.addAttribute("userRoles", roleService.getUserRoles(user));
        model.addAttribute("vulnerabilities", user.getVulnerbilites());
        return "resume";
    }

}
