package vuln.zsmart.ma.vulnnosql.Controller;

import org.bson.types.ObjectId;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import vuln.zsmart.ma.vulnnosql.Beans.*;
import vuln.zsmart.ma.vulnnosql.Services.MyUserDetailServices;
import vuln.zsmart.ma.vulnnosql.Services.RoleService;
import vuln.zsmart.ma.vulnnosql.Services.VulnerabilityService;

import java.util.ArrayList;
import java.util.Base64;
import java.util.List;
import java.util.Optional;

@Controller
public class VulnerabilityController {

    @Autowired
    VulnerabilityService vulnerabilityService;
    @Autowired
    MyUserDetailServices myUserDetailServices;
    @Autowired
    RoleService roleService;

    @PostMapping(value = "/tables.html/AddnewVuln")
    public String addVuln(@AuthenticationPrincipal UserPrincipal userPrincipal, Vulnerbilite v)
    {
        ObjectId id = userPrincipal.getId();
        Optional<User> userOP = myUserDetailServices.getUserById(id);
        User user = userOP.get();
        v.setAuthor(user);
        if(user.getVulnerbilites()==null)
        {
            List<Vulnerbilite> vulns = new ArrayList<>();
            vulns.add(v);
            user.setVulnerbilites(vulns);
        }else
        {
            user.getVulnerbilites().add(v);
        }
        vulnerabilityService.save(v);
        myUserDetailServices.save(user);

        return "redirect:/tables.html";
    }


    @RequestMapping("/tables.html/vulnerability/edit/{title}")
    public String updateVuln(@AuthenticationPrincipal UserPrincipal userPrincipal,@PathVariable String title, Model model)
    {
        ObjectId id = userPrincipal.getId();
        User user = myUserDetailServices.getUserById(id).get();
        Vulnerbilite vulnerbilite = vulnerabilityService.getVulnByTitle(title);
        Photo photo = user.getPhoto();
        if(photo!=null)
        {
            model.addAttribute("image", Base64.getEncoder().encodeToString(photo.getImage().getData()));
        }
        model.addAttribute("vulnEDIT",vulnerbilite);
        return "vulnEdit";
    }

    @PutMapping("/tables.html/update/vuln")
    public String tableUpdate(Vulnerbilite vulnerbilite)
    {
        Vulnerbilite Test = vulnerabilityService.findVulnById(vulnerbilite.getId()).get();
        if(Test !=null)
        {
            vulnerabilityService.save(Test);
            return "redirect:/tables.html/vulnerability/edit/"+Test.getTitle();
        }
        return "404";
    }

    @GetMapping("/tables.html/view/user/{username}")
    public String viewtUserVuln(@PathVariable String username, Model model){
        User user = myUserDetailServices.findUserByUsername(username);
        model.addAttribute("authorResume", user);
        model.addAttribute("userRoles", roleService.getUserRoles(user));
        model.addAttribute("vulnerabilities", user.getVulnerbilites());
        return "resume";
    }

}
